window.bibblioRecirculation=function(){return{bibblioStories:[],bibblioTrackingUrl:'',globalRecircUuids:[],totalCalls:0,getContent(contentId){this.globalRecircUuids=Array.from(document.querySelectorAll('[data-gcirc-uuid]')).map((item)=>item.getAttribute('data-gcirc-uuid'));this.getBibblioStories(contentId??null)},getBibblioStories(contentId){const cutoffDate=new Date('2016/03/21');const storyDate=window.publish_date?new Date(window.publish_date):null;if(this.bibblioStories.length<=0&&contentId&&(storyDate&&(storyDate.getTime()>cutoffDate.getTime()))){this.callBibblio(`https://api.bibblio.org/v1/recommendations?customUniqueIdentifier=${contentId}&limit=20&fields=url,name,headline,customUniqueIdentifier,moduleImage,customFields,author&customCatalogueIds=news,how-to,roundups,comparisons,reviews&shuffle=false`);}else{this.callBibblio(`https://api.bibblio.org/v1/recommendations/popular?limit=20&fields=url,name,headline,customUniqueIdentifier,moduleImage,customFields,author&customCatalogueIds=news,how-to,roundups,comparisons,reviews`)}
window.attachBibblioViewer();},callBibblio(url){fetch(url,{headers:{'Content-Type':'application/json','Authorization':`Bearer ${window.bibblioRecommendationKey}`,}}).then(response=>{this.totalCalls+=1;if(response.ok){return response.json()}else if(response.status===404&&this.totalCalls<2){this.callBibblio(`https://api.bibblio.org/v1/recommendations/popular?limit=20&fields=url,name,headline,customUniqueIdentifier,moduleImage,customFields,author&customCatalogueIds=news,how-to,roundups,comparisons,reviews`)}}).then(data=>{if(data.results&&data.results.length>0){let filteredResults=data.results.filter(item=>!this.globalRecircUuids.includes(item.fields.customUniqueIdentifier)).map(item=>{if(item.fields.customFields!=null){item.fields.name+=parseFloat(item.fields.customFields.rating)>0.0?' Review':' Preview';}else{item.fields.noCustomFields=true;}
return item});this.bibblioStories=filteredResults.slice(0,8);this.bibblioTrackingUrl=data._links.tracking.href
this.$nextTick(()=>{this.mountSlides()
let slide=this.$refs.slider.querySelector('.slide:nth-child(2)')?this.$refs.slider.querySelector('.slide:nth-child(2)'):this.$refs.slider.querySelector('.slide');setTimeout(()=>{this.defaultWidth=slide.getBoundingClientRect().width;},1000);this.$refs.slider.querySelector('.slider').scrollTo({left:this.scrollLeft,behavior:'smooth'});});}})},arrowsVisible:true,windowWidth:window.innerWidth,currentPageIndex:0,nextSlideIndex:0,touchBegin:0,touchFinish:0,reviews:[],scrollLeft:0,hasSwiped:false,defaultWidth:264,mountSlides:function(){let slides=this.$refs.slider.querySelectorAll('.slide:not(.md\\:hidden)');for(let i=0;i<slides.length;i++){this.reviews.push(slides[i].innerHTML)}},nextPage:function(){let slide=this.$refs.slider.querySelector('.slide:nth-child(2)')?this.$refs.slider.querySelector('.slide:nth-child(2)'):this.$refs.slider.querySelector('.slide');this.scrollLeft=parseInt(this.scrollLeft)+(slide.getBoundingClientRect().width*2);if(this.scrollLeft>=this.defaultWidth*this.reviews.length-(slide.getBoundingClientRect().width*2)){this.scrollLeft=this.defaultWidth*this.reviews.length-(slide.getBoundingClientRect().width*2);}
this.$refs.slider.querySelector('.slider').scrollTo({left:this.scrollLeft,behavior:'smooth'});},previousPage:function(){let slide=this.$refs.slider.querySelector('.slide:nth-child(2)')?this.$refs.slider.querySelector('.slide:nth-child(2)'):this.$refs.slider.querySelector('.slide');this.scrollLeft=parseInt(this.scrollLeft)-(slide.getBoundingClientRect().width*2);if(this.scrollLeft<0){this.scrollLeft=0;}
this.$refs.slider.querySelector('.slider').scrollTo({left:this.scrollLeft,behavior:'smooth'});},onWindowResize:window.debounce(function(){this.windowWidth=window.innerWidth},100),touchStart:function(event){this.touchBegin=event.changedTouches[0].clientX;},touchEnd:function(event){this.touchFinish=event.changedTouches[0].clientX;this.swipeHandler(this.touchFinish-this.touchBegin);},swipeHandler:function(direction){if(Math.abs(direction)>20&&window.ga){let directionSwiped=(direction>0)?'right':'left';window.ga('send',{hitType:'event',eventCategory:'swipe',eventAction:'sliding-carousel',eventLabel:'swiped-'+directionSwiped,'dimension2':window.legacy_template||null,'dimension33':window.template||null,'nonInteraction':0,transport:'beacon'});gtag('event','sliding-carousel',{event_category:'swipe',event_label:'swiped-'+directionSwiped,'non_interaction':false,});}},showPrevious:function(){return this.scrollLeft>0;},showNext:function(){return this.scrollLeft<this.defaultWidth*this.reviews.length-(this.$refs.slider?this.$refs.slider.getBoundingClientRect().width:0);},}}