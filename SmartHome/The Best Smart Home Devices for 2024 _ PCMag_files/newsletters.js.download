window.newsletters=function(){return{emailStore:window.EmailStore,hasError:false,isLoading:false,isSuccess:false,trackingSource:'',selectedNewsletters:[],email:'',errorMessage:'',uniqueId:0,subscribeEndPoint:'/user/subscribe',newsletters:[],setDefaultSelected(){if(window.location.pathname!=="/newsletter_manage"){return;}
let urlPartial=window.location.search.split('listIds=');if(urlPartial[1]){let urlParam=urlPartial[1].split('&')[0];let listIds=urlParam.split(',');for(let i=0;i<listIds.length;i++){let id=parseInt(listIds[i],10)||0;let idIsValid=this.newsletters.some(newsletter=>newsletter.list_id===id);if(idIsValid&&!this.listIsSelected(id)){this.toggleSelected(id);}}}},toggleSelected(listId){let newsletterIndex=this.searchInList(this.newsletters,listId);let selectedIndex=this.searchInList(this.selectedNewsletters,listId);if(selectedIndex>-1){this.selectedNewsletters.splice(selectedIndex,1);}else{this.selectedNewsletters.push(this.newsletters[newsletterIndex]);}},listIsSelected(listId){return this.searchInList(this.selectedNewsletters,listId)>-1;},searchInList(newsletterList,listId){let result=-1;newsletterList.forEach((newsletter,index)=>{if(newsletter.list_id==listId){result=index;return;}});return result;},submitForm(){this.subscribeEmail();},titlesSelected(){let selected=[];this.newsletters.forEach((newsletter)=>{if(this.listIsSelected(newsletter.list_id)){selected.push(newsletter.title);}});return selected.join();},subscribeEmail(){if(!this.validSubmission()||this.isLoading){return;}
let self=this;this.isLoading=true;this.hasError=false;let courierLists=[];this.selectedNewsletters.forEach((newsletter)=>{courierLists.push(newsletter.courier_list);});fetch(this.subscribeEndPoint,{method:"POST",headers:{"Content-Type":"application/json",},body:JSON.stringify({email:this.email,source:this.trackingSource,listIds:this.listIds().join(),courierLists:courierLists.join()})}).then(response=>response.json()).then(function(resp){self.isLoading=false;if(resp&&resp.some(item=>item.isSuccess===true)){self.subscribeSuccess();self.addTrackingPixels(resp.data);}
else{self.hasError=true;self.errorMessage='Something went wrong. Please try again.';self.resetFocus();}}).catch(function(error){self.isLoading=false;self.hasError=true;self.errorMessage='Something went wrong. Please try again.';self.resetFocus();})},resetFocus(){this.$refs.newsletterInput.focus();},subscribeSuccess(){this.isSuccess=true;var event=new CustomEvent('form-onSuccess',{detail:{value:this.isSuccess}});window.dispatchEvent(event);EmailStore.subscribeUser();this.suppressRententionScript();},suppressRententionScript(){if(geq==='undefined'||geq==null)
{!function(){var geq=window.geq=window.geq||[];if(geq.initialize)return;if(geq.invoked){if(window.console&&console.error){console.error("GE snippet included twice.");}return;}geq.invoked=true;geq.methods=["page","suppress","trackOrder","identify","addToCart","callBack","event"];geq.factory=function(method){return function(){var args=Array.prototype.slice.call(arguments);args.unshift(method);geq.push(args);return geq;};};for(var i=0;i<geq.methods.length;i++){var key=geq.methods[i];geq[key]=geq.factory(key);}geq.load=function(key){var script=document.createElement("script");script.type="text/javascript";script.async=true;if(location.href.includes("vge=true")){script.src="https://s3-us-west-2.amazonaws.com/jsstore/a/"+key+"/ge.js?v="+Math.random();}else{script.src="https://s3-us-west-2.amazonaws.com/jsstore/a/"+key+"/ge.js";}var first=document.getElementsByTagName("script")[0];first.parentNode.insertBefore(script,first);};geq.SNIPPET_VERSION="1.6.1";geq.load("K97H2Y2");}();}
geq.suppress();},addTrackingPixels(response){for(let i=0;i<response.length;i++){if(response[i]['isSuccess']){let zdbbImg=document.createElement('img');zdbbImg.src=`https://zdbb.net/l/KRlw-jBMEeOsSCIACh-JyA?email_address=${this.email}&mailing=${response[i]['id']}`;document.querySelector('body').append(zdbbImg);}}},validSubmission(){if(this.email===''){this.errorMessage='Invalid email. Please resubmit.';this.hasError=true;this.resetFocus();return false;}
if(this.listIds().length===0&&window.location.pathname==="/newsletter_manage"){this.errorMessage='Please select a subscription list.';this.hasError=true;this.resetFocus();return false;}
return true;},getTrackingSource(){this.trackingSource=this.$refs.emailForm?this.$refs.emailForm.getAttribute('tracking-source'):'';},showEmailSignUp(){return!this.emailStore.state.userIsInEu;},showEmailForm(){return!this.emailStore.state.userIsInEu;},inputClasses(){return{'border-red-400':this.hasError,'border-gray-200':!this.hasError,'rounded-l':this.showSubmitButton,'rounded border-r':!this.showSubmitButton}},listIds(){let ids=[];this.selectedNewsletters.forEach((newsletter)=>{ids.push(newsletter.list_id);});return ids;},init(){EmailStore.checkIsUserEu();EmailStore.checkIsSubscribed();this.showEmailSignUp();this.showEmailForm();this.inputClasses();this.getTrackingSource();var self=this;this.$watch('isLoading',function(newValue){var event=new CustomEvent('form-isLoading',{detail:{value:newValue}});window.dispatchEvent(event);});this.$watch('hasError',function(newValue){var event=new CustomEvent('form-hasError',{detail:{value:newValue}});window.dispatchEvent(event);});this.$watch('email',function(){self.hasError=false});},initNewsletter(newsletter){this.newsletters=[newsletter];this.selectedNewsletters.push(newsletter);},initNewsletters(newsletters){this.newsletters=newsletters;this.setDefaultSelected();}}};